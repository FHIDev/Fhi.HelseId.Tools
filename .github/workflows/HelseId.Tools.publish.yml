# This workflow will build a .NET project
# For more information see: https://docs.github.com/en/actions/automating-builds-and-tests/building-and-testing-net

name: HelseId.Tools.Publish

on:
  push:
    branches:
      - main
  workflow_dispatch:
  release:
    types: [created]  

jobs:
  build-and-publish-executable:
    runs-on: ubuntu-latest
    steps:
    - name: Debug GITHUB_TOKEN
      run: |
        echo "Attempting to debug GITHUB_TOKEN."
        if [ -n "${{ secrets.GITHUB_TOKEN }}" ] && [ "${{ secrets.GITHUB_TOKEN }}" != "" ]; then
          echo "GITHUB_TOKEN is present."
        else
          echo "GITHUB_TOKEN is EMPTY or not set!"
        fi

    - uses: actions/checkout@v4
      with:
        token: ${{ secrets.GITHUB_TOKEN }}
  
    - name: Setup .NET
      uses: actions/setup-dotnet@v4
      with:
        dotnet-version: 9.0.x

    - name: Build Project
      run: dotnet build ./src/Fhi.HelseIdSelvbetjening.CLI/Fhi.HelseIdSelvbetjening.CLI.csproj --configuration Release

    - name: Publish Executable
      run: dotnet publish  ./src/Fhi.HelseIdSelvbetjening.CLI/Fhi.HelseIdSelvbetjening.CLI.csproj --configuration Release --output publish_output --self-contained true -p:PublishSingleFile=true --runtime win-x64

    - name: Get version details from tag
      #if: github.event_name == 'release'
      id: get_version_details
      run: |
        TAG_NAME="${GITHUB_REF#refs/tags/}"
        if [[ "$TAG_NAME" == beta_v* ]]; then
          VERSION_NUMBER="${TAG_NAME#beta_v}"
          FILENAME_VERSION_SUFFIX="beta-${VERSION_NUMBER}"
        elif [[ "$TAG_NAME" == v* ]]; then
          VERSION_NUMBER="${TAG_NAME#v}"
          FILENAME_VERSION_SUFFIX="v${VERSION_NUMBER}"
        else
          VERSION_NUMBER="$TAG_NAME" 
          FILENAME_VERSION_SUFFIX="$TAG_NAME"
        fi
        echo "VERSION_NUMBER=${VERSION_NUMBER}" >> $GITHUB_OUTPUT
        echo "FILENAME_VERSION_SUFFIX=${FILENAME_VERSION_SUFFIX}" >> $GITHUB_OUTPUT

    - name: Zip published files for release
      #if: github.event_name == 'release'
      run: |
        cd publish_output
        zip -r ../helseid-cli-win-x64-${{ steps.get_version_details.outputs.FILENAME_VERSION_SUFFIX }}.zip .
        cd ..

    - name: Upload Release Asset (Zip)
      #if: github.event_name == 'release'
      uses: actions/upload-release-asset@v1
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
      with:
        upload_url: ${{ github.event.release.upload_url }}
        asset_path: ./helseid-cli-win-x64-${{ steps.get_version_details.outputs.FILENAME_VERSION_SUFFIX }}.zip
        asset_name: helseid-cli-win-x64-${{ steps.get_version_details.outputs.FILENAME_VERSION_SUFFIX }}.zip
        asset_content_type: application/zip

    - name: Upload artifact
      uses: actions/upload-artifact@v4
      with:
        name: published-app
        path: publish_output/
        retention-days: 2  # Optional: Set retention period

  # publish-nuget:
  #   runs-on: ubuntu-latest
  #   # Only run when a release is created
  #   if: github.event_name == 'release'
  #   steps:
  #   - uses: actions/checkout@v4
  #     with:
  #       token: ${{ secrets.GITHUB_TOKEN }}
  
  #   - name: Setup .NET
  #     uses: actions/setup-dotnet@v4
  #     with:
  #       dotnet-version: 9.0.x

  #   - name: Get version from tag
  #     id: get_version
  #     run: echo "VERSION=${GITHUB_REF#refs/tags/v}" >> $GITHUB_OUTPUT

  #   - name: Pack NuGet package
  #     run: |
  #       dotnet pack ./src/Fhi.HelseIdSelvbetjening.CLI/Fhi.HelseIdSelvbetjening.CLI.csproj \
  #       --configuration Release \
  #       -p:PackageVersion=${{ steps.get_version.outputs.VERSION }} \
  #       --output nuget-packages

  #   - name: Publish NuGet package
  #     run: dotnet nuget push ./nuget-packages/*.nupkg --api-key ${{ secrets.NUGET_API_KEY }} --source https://api.nuget.org/v3/index.json
  #     if: github.event_name == 'release'

  #   - name: Upload NuGet Package Artifact
  #     uses: actions/upload-artifact@v4
  #     with:
  #       name: nuget-package
  #       path: nuget-packages/*.nupkg
  #       retention-days: 7
